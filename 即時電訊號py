import paho.mqtt.client as mqtt
import struct
import time
from collections import deque
import matplotlib.pyplot as plt
from matplotlib.animation import FuncAnimation

# ================= è¨­å®šå€ =================
MQTT_BROKER_HOST = "192.168.1.24" 
MQTT_PORT        = 1883
MQTT_TOPIC       = "LS_Lab/sensor/adc/binary"

# çµæ§‹æ ¼å¼: < (Little Endian), i (int32), L (uint32)
STRUCT_FORMAT = '<iL'
SAMPLE_BYTES  = struct.calcsize(STRUCT_FORMAT)

# âš ï¸ é‚„åŸå€ç‡ (å¿…é ˆèˆ‡ ESP32 çš„ SCALING_FACTOR ä¸€è‡´)
SCALING_DIVISOR = 10.0

# ================= ç¹ªåœ–è®Šæ•¸ =================
MAX_SAMPLES = 2000
data_val  = deque(maxlen=MAX_SAMPLES)
data_time = deque(maxlen=MAX_SAMPLES)

start_time = time.time()
total_samples_received = 0
last_throughput_time = time.time()

# è¨­å®šåœ–è¡¨é¢¨æ ¼
plt.style.use('dark_background')
fig, ax = plt.subplots(figsize=(10, 6))
line, = ax.plot([], [], color='#00ff00', linewidth=1.5)

ax.set_title(f'Real-time ADS1115 (Scaled x10)', fontsize=14)
ax.set_ylabel('Voltage (mV)', fontsize=12)
ax.set_xlabel('Time (s)', fontsize=12)
ax.set_ylim(-300, 300) # è¦–æƒ…æ³èª¿æ•´
ax.grid(True, linestyle='--', alpha=0.3)

# ================= MQTT å›å‘¼ =================
def on_connect(client, userdata, flags, rc, properties=None):
    if rc == 0:
        print("âœ… Connected to MQTT Broker!")
        client.subscribe(MQTT_TOPIC)
    else:
        print(f"âŒ Connection failed: {rc}")

def on_message(client, userdata, msg):
    global total_samples_received
    payload = msg.payload
    
    # ä½¿ç”¨ iter_unpack é«˜æ•ˆè§£æ
    try:
        for diff_scaled, dt in struct.iter_unpack(STRUCT_FORMAT, payload):
            # 1. é‚„åŸé›»å£“ï¼šæ•´æ•¸ 126 / 10.0 = 12.6 mV
            real_voltage = diff_scaled / SCALING_DIVISOR
            
            # 2. è¨ˆç®—æ™‚é–“
            current_time = time.time() - start_time
            
            data_val.append(real_voltage)
            data_time.append(current_time)
            total_samples_received += 1
            
    except struct.error as e:
        print(f"Error unpacking struct: {e}")

# ================= å‹•ç•«æ›´æ–° (ä¿®æ­£ç‰ˆ) =================
def update_plot(frame):
    global last_throughput_time, total_samples_received
    
    # è‹¥æœ‰æ•¸æ“šæ‰æ›´æ–°åœ–è¡¨
    if len(data_time) > 1:
        line.set_data(data_time, data_val)
        ax.set_xlim(data_time[-1] - 5, data_time[-1]) # é¡¯ç¤ºæœ€è¿‘ 5 ç§’

    # è¨ˆç®—ååé‡
    now = time.time()
    if now - last_throughput_time >= 1.0:
        rate = total_samples_received / (now - last_throughput_time)
        
        # ğŸ”¥ å®‰å…¨æª¢æŸ¥ï¼šç¢ºä¿æœ‰æ•¸æ“šæ‰è®€å–æœ€å¾Œä¸€ç­†
        if len(data_val) > 0:
            print(f"ğŸš€ Speed: {rate:.2f} samples/s | Last Value: {data_val[-1]:.2f} mV")
        else:
            print(f"ğŸš€ Speed: {rate:.2f} samples/s | Last Value: Waiting...")
            
        total_samples_received = 0
        last_throughput_time = now

    return line,

# ================= ä¸»ç¨‹å¼ =================
if __name__ == '__main__':
    # ä½¿ç”¨æ–°ç‰ˆ API
    client = mqtt.Client(mqtt.CallbackAPIVersion.VERSION2)
    client.on_connect = on_connect
    client.on_message = on_message

    try:
        client.connect(MQTT_BROKER_HOST, MQTT_PORT, 60)
        client.loop_start()

        ani = FuncAnimation(fig, update_plot, interval=50, blit=True, cache_frame_data=False)
        plt.show()

    except KeyboardInterrupt:
        print("Stopping...")
    finally:
        client.loop_stop()
        client.disconnect()
